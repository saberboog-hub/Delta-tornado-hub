--[[
	Orbit System
	Parte 1 - Base do sistema (servidor)

	Essa parte:
	- Cria dados por player
	- Recebe ON / OFF
	- Recebe ALTURA
	- NÃO faz nada no jogo ainda
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local remote = ReplicatedStorage:WaitForChild("OrbitRemote")

-- Tabela de dados por jogador
local playerData = {}

-- Player entrou
Players.PlayerAdded:Connect(function(player)
	playerData[player] = {
		enabled = false,
		height = 10
	}

	print("[Orbit | Parte 1] Dados criados para", player.Name)
end)

-- Player saiu
Players.PlayerRemoving:Connect(function(player)
	playerData[player] = nil
	print("[Orbit | Parte 1] Dados removidos de", player.Name)
end)

-- Recebe dados (por enquanto só salva)
remote.OnServerEvent:Connect(function(player, enabled, height)
	if not playerData[player] then return end

	playerData[player].enabled = enabled == true
	playerData[player].height = math.clamp(tonumber(height) or 10, 0, 50)

	print(
		"[Orbit | Parte 1]",
		player.Name,
		"ON:", playerData[player].enabled,
		"ALTURA:", playerData[player].height
	)
end)
--[[
	Orbit System
	Parte 2 - Botão pequeno "Abrir"

	Essa parte:
	- Cria um botão flutuante
	- Funciona no mobile
	- É arrastável
	- NÃO abre menu ainda
]]

local gui = script.Parent
gui.ResetOnSpawn = false

-- Botão "Abrir"
local openButton = Instance.new("TextButton")
openButton.Name = "OpenButton"
openButton.Size = UDim2.fromOffset(90, 35)
openButton.Position = UDim2.fromScale(0.05, 0.5)
openButton.Text = "Abrir"
openButton.Font = Enum.Font.GothamBold
openButton.TextSize = 14
openButton.TextColor3 = Color3.new(1, 1, 1)
openButton.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
openButton.Parent = gui

-- Cantos arredondados
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 8)
corner.Parent = openButton

-- Mobile friendly
openButton.Active = true
openButton.Draggable = true

-- Clique (debug)
openButton.MouseButton1Click:Connect(function()
	print("[Orbit | Parte 2] Botão Abrir clicado")
end)
--[[
	Orbit System
	Parte 3 - Menu grande + minimizar

	Essa parte:
	- Cria o menu grande
	- Cria o botão "-"
	- Permite esconder o menu
	- NÃO tem funções reais
]]

local gui = script.Parent
gui.ResetOnSpawn = false

-- ======================
-- MENU GRANDE
-- ======================
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainMenu"
mainFrame.Size = UDim2.fromOffset(320, 220)
mainFrame.Position = UDim2.from
--[[
	Orbit System
	Parte 4 - Funções (ON / OFF + Altura)

	Essa parte:
	- Cria botão ON / OFF
	- Cria slider de Altura (0 a 50)
	- NÃO aplica efeito nenhum
	- NÃO fala com servidor
]]

local UIS = game:GetService("UserInputService")

local gui = script.Parent
gui.ResetOnSpawn = false

-- ======================
-- ESTADO
-- ======================
local enabled = false
local heightValue = 10

-- ======================
-- BOTÃO ON / OFF
-- ======================
local toggle = Instance.new("TextButton")
toggle.Size = UDim2.fromOffset(260, 40)
toggle.Position = UDim2.from
--[[
	Orbit System
	Parte 5 - Sistema de órbita (servidor)

	Essa parte:
	- Puxa estruturas soltas
	- Faz orbitar acima do jogador
	- NÃO usa menu
	- NÃO usa RemoteEvent
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- CONFIGURAÇÕES
local ORBIT_RADIUS = 8          -- distância lateral
local ORBIT_HEIGHT = 10         -- altura acima do jogador
local PULL_FORCE = 120
local SPIN_FORCE = 90

-- Função principal
local function applyOrbit(player)
	local character = player.Character
	if not character then return end

	local hrp = character:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	for _, part in ipairs(workspace:GetDescendants()) do
		if part:IsA("BasePart")
			and not part.Anchored
			and not part:IsDescendantOf(character) then

			local targetPos = hrp.Position + Vector3.new(0, ORBIT_HEIGHT, 0)
			local offset = part.Position - targetPos
			local distance = offset.Magnitude

			if distance <= ORBIT_RADIUS then
				local att = part:FindFirstChild("OrbitAtt")
				if not att then
					att = Instance.new("Attachment")
					att.Name = "OrbitAtt"
					att.Parent = part
				end

				local vf = part:FindFirstChild("OrbitForce")
				if not vf then
					vf = Instance.new("VectorForce")
					vf.Name = "OrbitForce"
					vf.Attachment0 = att
					vf.RelativeTo = Enum.ActuatorRelativeTo.World
					vf.Parent = part
				end

				local pullDir = (targetPos - part.Position).Unit
				local pull = pullDir * PULL_FORCE * part.AssemblyMass

				local spinDir = Vector3.new(-pullDir.Z, 0, pullDir.X)
				local spin = spinDir * SPIN_FORCE * part.AssemblyMass

				vf.Force = pull + spin
			end
		end
	end
end

-- Loop
RunService.Heartbeat:Connect(function()
	for _, player in ipairs(Players:GetPlayers()) do
		applyOrbit(player)
	end
end)
